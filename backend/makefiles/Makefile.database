##@ ðŸ—„ï¸  Banco de Dados - Migrations

migrate: ## Executa migrations pendentes
	@echo "$(GREEN)ðŸ—„ï¸  Executando migrations...$(NC)"
	docker compose exec php php artisan migrate

migrate-fresh: ## Dropa tudo e recria (âš ï¸ APAGA DADOS!)
	@echo "$(RED)âš ï¸  ATENÃ‡ÃƒO: Isso vai apagar todos os dados!$(NC)"
	@read -p "Tem certeza? [s/N]: " confirm; \
	if [ "$$confirm" = "s" ] || [ "$$confirm" = "S" ]; then \
		docker compose exec php php artisan migrate:fresh; \
	else \
		echo "Cancelado."; \
	fi

migrate-fresh-seed: ## Dropa, recria e popula o banco
	@echo "$(RED)âš ï¸  ATENÃ‡ÃƒO: Isso vai apagar todos os dados!$(NC)"
	@read -p "Tem certeza? [s/N]: " confirm; \
	if [ "$$confirm" = "s" ] || [ "$$confirm" = "S" ]; then \
		docker compose exec php php artisan migrate:fresh --seed; \
	else \
		echo "Cancelado."; \
	fi

migrate-refresh: ## Rollback e re-executa todas migrations
	docker compose exec php php artisan migrate:refresh

migrate-refresh-seed: ## Rollback, re-executa e popula
	docker compose exec php php artisan migrate:refresh --seed

migrate-rollback: ## Desfaz Ãºltima migraÃ§Ã£o
	docker compose exec php php artisan migrate:rollback

migrate-rollback-step: ## Desfaz N migraÃ§Ãµes
	@read -p "Quantos steps desfazer? " steps; \
	docker compose exec php php artisan migrate:rollback --step=$$steps

migrate-reset: ## Desfaz todas as migraÃ§Ãµes
	docker compose exec php php artisan migrate:reset

migrate-status: ## Mostra status das migrations
	docker compose exec php php artisan migrate:status

migrate-install: ## Instala repositÃ³rio de migrations
	docker compose exec php php artisan migrate:install

schema-dump: ## Dump do schema do banco de dados
	docker compose exec php php artisan schema:dump


##@ ðŸ—„ï¸  Banco de Dados - OperaÃ§Ãµes

db-show: ## Mostra informaÃ§Ãµes do banco
	docker compose exec php php artisan db:show

db-table: ## Mostra estrutura de uma tabela
	@read -p "Nome da tabela: " table; \
	docker compose exec php php artisan db:table $$table

db-monitor: ## Monitora conexÃµes do banco
	docker compose exec php php artisan db:monitor

db-wipe: ## Limpa todas as tabelas (âš ï¸ APAGA DADOS!)
	@echo "$(RED)âš ï¸  ATENÃ‡ÃƒO: Isso vai apagar todos os dados!$(NC)"
	@read -p "Tem certeza? [s/N]: " confirm; \
	if [ "$$confirm" = "s" ] || [ "$$confirm" = "S" ]; then \
		docker compose exec php php artisan db:wipe; \
	else \
		echo "Cancelado."; \
	fi

seed: ## Executa todos os seeders
	@echo "$(GREEN)ðŸŒ± Executando seeders...$(NC)"
	docker compose exec php php artisan db:seed

seed-class: ## Executa um seeder especÃ­fico
	@read -p "Nome do seeder: " seeder; \
	docker compose exec php php artisan db:seed --class=$$seeder


##@ ðŸ’¾ Backup & Restore

backup-db: ## Faz backup do banco de dados
	@echo "$(GREEN)ðŸ’¾ Criando backup do banco...$(NC)"
	@mkdir -p backups
	@timestamp=$$(date +%Y%m%d_%H%M%S); \
	docker compose exec mysql mysqldump -u root -proot db_laravel > backups/db_backup_$$timestamp.sql && \
	echo "$(GREEN)âœ… Backup salvo em: backups/db_backup_$$timestamp.sql$(NC)"

restore-db: ## Restaura backup do banco
	@echo "$(YELLOW)Arquivos disponÃ­veis em backups/:$(NC)"
	@ls -lh backups/*.sql 2>/dev/null || echo "Nenhum backup encontrado"
	@read -p "Nome do arquivo (sem o path): " file; \
	if [ -f "backups/$$file" ]; then \
		echo "$(YELLOW)Restaurando backup...$(NC)"; \
		docker compose exec -T mysql mysql -u root -proot db_laravel < backups/$$file && \
		echo "$(GREEN)âœ… Backup restaurado!$(NC)"; \
	else \
		echo "$(RED)âŒ Arquivo nÃ£o encontrado!$(NC)"; \
	fi

backup-postgres: ## Faz backup do PostgreSQL
	@echo "$(GREEN)ðŸ’¾ Criando backup do PostgreSQL...$(NC)"
	@mkdir -p backups
	@timestamp=$$(date +%Y%m%d_%H%M%S); \
	docker compose exec postgres pg_dump -U developer db_laravel > backups/postgres_backup_$$timestamp.sql && \
	echo "$(GREEN)âœ… Backup salvo em: backups/postgres_backup_$$timestamp.sql$(NC)"

backup-postgres-custom: ## Faz backup customizado do PostgreSQL (com dados e estrutura)
	@echo "$(GREEN)ðŸ’¾ Criando backup customizado do PostgreSQL...$(NC)"
	@mkdir -p backups
	@timestamp=$$(date +%Y%m%d_%H%M%S); \
	docker compose exec postgres pg_dump -U developer -Fc db_laravel > backups/postgres_custom_$$timestamp.dump && \
	echo "$(GREEN)âœ… Backup customizado salvo em: backups/postgres_custom_$$timestamp.dump$(NC)"

restore-postgres: ## Restaura backup do PostgreSQL
	@echo "$(YELLOW)Arquivos disponÃ­veis em backups/:$(NC)"
	@ls -lh backups/postgres_*.sql backups/postgres_*.dump 2>/dev/null || echo "Nenhum backup encontrado"
	@read -p "Nome do arquivo (sem o path): " file; \
	if [ -f "backups/$$file" ]; then \
		echo "$(YELLOW)Restaurando backup...$(NC)"; \
		if echo "$$file" | grep -q "\.dump$$"; then \
			docker compose exec -T postgres pg_restore -U developer -d db_laravel < backups/$$file && \
			echo "$(GREEN)âœ… Backup customizado restaurado!$(NC)"; \
		else \
			docker compose exec -T postgres psql -U developer -d db_laravel < backups/$$file && \
			echo "$(GREEN)âœ… Backup SQL restaurado!$(NC)"; \
		fi \
	else \
		echo "$(RED)âŒ Arquivo nÃ£o encontrado!$(NC)"; \
	fi

psql-list-databases: ## Lista todos os bancos de dados PostgreSQL
	docker compose exec postgres psql -U developer -l

psql-list-tables: ## Lista todas as tabelas do banco
	docker compose exec postgres psql -U developer -d db_laravel -c "\dt"

psql-describe-table: ## Descreve estrutura de uma tabela
	@read -p "Nome da tabela: " table; \
	docker compose exec postgres psql -U developer -d db_laravel -c "\d $$table"

psql-exec: ## Executa comando SQL no PostgreSQL
	@read -p "Comando SQL: " query; \
	docker compose exec postgres psql -U developer -d db_laravel -c "$$query"

psql-vacuum: ## Executa VACUUM no banco (limpeza e otimizaÃ§Ã£o)
	@echo "$(YELLOW)ðŸ”„ Executando VACUUM...$(NC)"
	docker compose exec postgres psql -U developer -d db_laravel -c "VACUUM FULL ANALYZE;"
	@echo "$(GREEN)âœ… VACUUM concluÃ­do!$(NC)"

psql-stats: ## Mostra estatÃ­sticas do PostgreSQL
	docker compose exec postgres psql -U developer -d db_laravel -c "SELECT pg_size_pretty(pg_database_size('db_laravel')) AS database_size;"

psql-connections: ## Mostra conexÃµes ativas
	docker compose exec postgres psql -U developer -d db_laravel -c "SELECT pid, usename, application_name, client_addr, state FROM pg_stat_activity;"

